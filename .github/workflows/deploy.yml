name: Deploy Bot to VPS

# Minimal deploy workflow (password-based SSH). Expects these repo secrets:
# - PROD_DEPLOY_HOST
# - PROD_DEPLOY_USER
# - PROD_DEPLOY_PATH
# - PROD_SSH_PASSWORD

on:
  workflow_dispatch:
    inputs:
      deployment_branch:
        description: 'Branch to deploy'
        required: true
        default: 'main'
        type: string
      deployment_type:
        description: 'Deployment type'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - backend-only

permissions:
  contents: read
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deployment_branch }}

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass rsync util-linux

      - name: Package backend
        run: |
          mkdir -p deployment-package
          rsync -av --exclude='*.pyc' --exclude='__pycache__' --exclude='.env' --exclude='venv/' \
            src/ deployment-package/src/
          cp requirements.txt deployment-package/ || true

      - name: Deploy to server
        env:
          PROD_DEPLOY_PATH: ${{ secrets.PROD_DEPLOY_PATH }}
          PROD_DEPLOY_HOST: ${{ secrets.PROD_DEPLOY_HOST }}
          PROD_DEPLOY_USER: ${{ secrets.PROD_DEPLOY_USER }}
          PROD_SSH_PASSWORD: ${{ secrets.PROD_SSH_PASSWORD }}
        run: |
          set -euo pipefail

          # Compute release path once on the runner
          RELEASE_ROOT="${PROD_DEPLOY_PATH}/releases"
          TIMESTAMP="$(date +%Y%m%d-%H%M%S)"
          REMOTE_DIR="${RELEASE_ROOT}/${TIMESTAMP}"

          echo "Creating remote release dir: ${REMOTE_DIR}"
          sshpass -p "${PROD_SSH_PASSWORD}" ssh -o StrictHostKeyChecking=no \
            ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} "mkdir -p '${REMOTE_DIR}'"

          echo "Uploading files to ${REMOTE_DIR}"
          rsync -avz --delete -e "sshpass -p '${PROD_SSH_PASSWORD}' ssh -o StrictHostKeyChecking=no" \
            deployment-package/ ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST}:"${REMOTE_DIR}/"

          echo "Finalizing deploy on remote host (atomic privileged block)"
          KEEP=5
          # Pass REMOTE_DIR into the sudo environment so the remote block uses the same directory we uploaded to.
          sshpass -p "${PROD_SSH_PASSWORD}" ssh -o StrictHostKeyChecking=no \
            ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} \
            "sudo PROD_DEPLOY_PATH='${PROD_DEPLOY_PATH}' PROD_DEPLOY_USER='${PROD_DEPLOY_USER}' REMOTE_DIR='${REMOTE_DIR}' bash -s" <<'EOF'
          set -euo pipefail
          set -x

          RELEASE_ROOT="${PROD_DEPLOY_PATH}/releases"
          KEEP=5

          mkdir -p "${RELEASE_ROOT}"

          if ! command -v python3 >/dev/null 2>&1; then
            echo "python3 not found on remote host" >&2; exit 1
          fi

          # Use the REMOTE_DIR passed from the runner (do NOT recompute TIMESTAMP/REMOTE_DIR here)
          echo "Using REMOTE_DIR: ${REMOTE_DIR}"

          python3 -m venv "${REMOTE_DIR}/venv"
          "${REMOTE_DIR}/venv/bin/pip" install --upgrade pip setuptools wheel || true
          if [ -f "${REMOTE_DIR}/requirements.txt" ]; then
            "${REMOTE_DIR}/venv/bin/pip" install -r "${REMOTE_DIR}/requirements.txt" || true
          fi

          if [ -e "${PROD_DEPLOY_PATH}/current" ] && [ ! -L "${PROD_DEPLOY_PATH}/current" ]; then
            mv "${PROD_DEPLOY_PATH}/current" "${PROD_DEPLOY_PATH}/releases/previous-current-$(date +%Y%m%d-%H%M%S)" || true
          fi

          ln -sfn "${REMOTE_DIR}" "${PROD_DEPLOY_PATH}/current"
          echo "SYMLINK_AFTER_UPDATE: $(readlink -f "${PROD_DEPLOY_PATH}/current")"

          chown -R ${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER} "${REMOTE_DIR}" || true
          chown -h ${PROD_DEPLOY_USER}:${PROD_DEPLOY_USER} "${PROD_DEPLOY_PATH}/current" || true

          cd "${RELEASE_ROOT}" || exit 0
          ls -1dt * 2>/dev/null | tail -n +$((KEEP+1)) | xargs -r rm -rf || true

          if systemctl list-units --full -all | grep -q '^esports-bot.service'; then
            systemctl daemon-reload || true
            systemctl restart esports-bot || true
            systemctl status esports-bot --no-pager || true
          fi

          echo "Deployed to ${REMOTE_DIR}"
          EOF

          echo "Deployment finished. Current points to:"
          sshpass -p "${PROD_SSH_PASSWORD}" ssh -o StrictHostKeyChecking=no \
            ${PROD_DEPLOY_USER}@${PROD_DEPLOY_HOST} "readlink -f '${PROD_DEPLOY_PATH}/current' || true"